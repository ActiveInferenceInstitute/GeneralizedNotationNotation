#!/usr/bin/env python3
"""
ActiveInference.jl Analyzer module.
This module orchestrates the execution of Julia analysis scripts on the output
generated by the ActiveInference.jl execution runner.

Architecture:
    Analysis Step (Python) -> Calls Julia Analysis Scripts -> Generates Plots/Reports
"""

from pathlib import Path
from typing import List, Optional
import logging
import subprocess
import os

logger = logging.getLogger("analysis.activeinference_jl")

def generate_analysis_from_logs(execution_results_dir: Path, output_dir: Path, verbose: bool = False) -> List[str]:
    """
    Generate analysis and visualizations for ActiveInference.jl results.
    
    The ActiveInference.jl execution creates visualizations during its run (in timestamped folders).
    This analyzer collects those existing visualizations and copies them to the analysis output.
    
    Args:
        execution_results_dir: Directory containing execution results (12_execute_output)
        output_dir: Directory to save analysis outputs (16_analysis_output/activeinference_jl)
        verbose: Enable verbose logging
        
    Returns:
        List of generated visualization file paths
    """
    generated_files = []
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # Search locations for ActiveInference.jl outputs:
    # 1. The execution_results_dir (12_execute_output)
    # 2. The sibling render output (11_render_output) - where Julia actually writes visualizations
    
    search_dirs = [execution_results_dir]
    
    # Add sibling render output directory
    render_output = execution_results_dir.parent / "11_render_output"
    if render_output.exists():
        search_dirs.append(render_output)
        if verbose:
            logger.info(f"Also searching render output: {render_output}")
    
    target_dirs = []
    
    for search_dir in search_dirs:
        # Look for timestamped output directories
        target_dirs.extend(list(search_dir.glob("**/activeinference_outputs_*")))
        
        # Also look for data_traces folders (alternative structure)
        data_trace_dirs = list(search_dir.glob("**/data_traces"))
        for dt in data_trace_dirs:
            if "activeinference" in str(dt.parent).lower() or "actinf" in str(dt.parent).lower():
                target_dirs.append(dt.parent)
    
    # Deduplicate and sort by modification time (newest first)
    target_dirs = list(set(target_dirs))
    target_dirs.sort(key=lambda p: p.stat().st_mtime if p.exists() else 0, reverse=True)
    
    if not target_dirs:
        logger.info(f"No ActiveInference.jl output directories found")
        return generated_files
    
    logger.info(f"Found {len(target_dirs)} ActiveInference.jl output directories")
    
    # Collect existing visualizations from most recent directory first
    import shutil
    
    for target_dir in target_dirs[:3]:  # Process up to 3 most recent
        if verbose:
            logger.info(f"Processing ActiveInference.jl output: {target_dir.name}")
        
        # Check for visualizations folder
        viz_dir = target_dir / "visualizations"
        if viz_dir.exists():
            for img_file in viz_dir.glob("*.png"):
                # Copy to analysis output
                dest_file = output_dir / img_file.name
                try:
                    shutil.copy2(img_file, dest_file)
                    generated_files.append(str(dest_file))
                    logger.info(f"Collected visualization: {img_file.name}")
                except Exception as e:
                    logger.warning(f"Failed to copy {img_file.name}: {e}")
        
        # Also check for analysis folder
        analysis_dir = target_dir / "analysis"
        if analysis_dir.exists():
            for f in analysis_dir.glob("**/*"):
                if f.is_file():
                    generated_files.append(str(f))
        
        # If we found visualizations, stop (use most recent only)
        if generated_files:
            break
    
    if generated_files:
        logger.info(f"Collected {len(generated_files)} ActiveInference.jl visualization files")
    
    return generated_files


#!/usr/bin/env python3
"""
ActiveInference.jl Analyzer module.
This module orchestrates the execution of Julia analysis scripts on the output
generated by the ActiveInference.jl execution runner.

Architecture:
    Analysis Step (Python) -> Calls Julia Analysis Scripts -> Generates Plots/Reports
"""

from pathlib import Path
from typing import List, Optional
import logging
import subprocess
import os

logger = logging.getLogger("analysis.activeinference_jl")

def generate_analysis_from_logs(execution_results_dir: Path, output_dir: Path, verbose: bool = False) -> List[str]:
    """
    Generate analysis and visualizations for ActiveInference.jl results.
    
    Args:
        execution_results_dir: Directory containing execution results
        output_dir: Directory to save analysis outputs
        verbose: Enable verbose logging
        
    Returns:
        List of generated visualization file paths
    """
    generated_files = []
    
    # Locate the Julia analysis scripts
    # They should be in the same directory as this file's parent / "activeinference_jl"
    analysis_scripts_dir = Path(__file__).parent / "activeinference_jl"
    
    if not analysis_scripts_dir.exists():
        logger.error(f"ActiveInference.jl analysis scripts not found at {analysis_scripts_dir}")
        return generated_files
        
    # Find execution output directories for ActiveInference.jl
    # Look for directories starting with "activeinference_outputs_"
    
    # We might be pointed at "12_execute_output" which contains "actinf_pomdp_agent/activeinference_jl"
    # or potentially the runners output to specific timestamped folders.
    
    # Search strategy:
    # 1. Look for specific activeinference output folders
    # 2. Look for project-structured output
    
    target_dirs = []
    
    # Check for direct timestamped outputs
    target_dirs.extend(list(execution_results_dir.glob("**/activeinference_outputs_*")))
    
    # Check for project structure
    # e.g. output/12_execute_output/actinf_pomdp_agent/activeinference_jl/execution_logs
    # The Julia scripts expect the root of the "activeinference_outputs_..." folder structure
    # which contains "logs", "data_traces", etc.
    
    # If the runner output to a fixed directory structure like "activeinference_jl", we need to see if it maintained the structure.
    # The runner `setup_output_directories` creates "logs", "data_traces", etc.
    
    # Let's search for "data_traces" folders and assume their parent is a valid target
    data_trace_dirs = list(execution_results_dir.glob("**/data_traces"))
    for dt in data_trace_dirs:
        if "activeinference" in str(dt.parent).lower() or "actinf" in str(dt.parent).lower():
            target_dirs.append(dt.parent)
            
    # Deduplicate
    target_dirs = list(set(target_dirs))
    
    if not target_dirs:
        logger.info(f"No ActiveInference.jl output directories found in {execution_results_dir}")
        return generated_files
        
    logger.info(f"Found {len(target_dirs)} ActiveInference.jl output directories to analyze")
    
    for target_dir in target_dirs:
        logger.info(f"Running Julia analysis on {target_dir}")
        
        # Define scripts to run
        scripts_to_run = [
            "visualization_suite.jl",
            "analysis_suite.jl", 
            # "enhanced_integration_suite.jl" # Optional, might take longer
        ]
        
        for script_name in scripts_to_run:
            script_path = analysis_scripts_dir / script_name
            if not script_path.exists():
                logger.warning(f"Analysis script not found: {script_path}")
                continue
                
            try:
                cmd = ["julia", str(script_path), str(target_dir)]
                if verbose:
                    logger.info(f"Executing: {' '.join(cmd)}")
                
                # capture_output to keep logs clean unless verbose
                result = subprocess.run(
                    cmd, 
                    capture_output=True, 
                    text=True,
                    check=False
                )
                
                if result.returncode == 0:
                    logger.info(f"✅ Successfully ran {script_name}")
                    if verbose:
                        logger.debug(result.stdout)
                else:
                    logger.error(f"❌ Failed to run {script_name}")
                    logger.error(result.stderr)
                    if verbose:
                        logger.debug(result.stdout)
                        
            except Exception as e:
                logger.error(f"Error executing {script_name}: {e}")

    # Collect generated files (rudimentary check)
    # The Julia scripts output to target_dir/visualizations or target_dir/analysis
    for target_dir in target_dirs:
        viz_dir = target_dir / "visualizations"
        if viz_dir.exists():
            generated_files.extend([str(p) for p in viz_dir.glob("**/*") if p.is_file()])
            
        analysis_dir = target_dir / "analysis" 
        if analysis_dir.exists():
             generated_files.extend([str(p) for p in analysis_dir.glob("**/*") if p.is_file()])

    return generated_files
